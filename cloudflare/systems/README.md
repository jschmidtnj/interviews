# systems cloudflare assignment

## endpoints

Hosted at https://api.postit.monster with cloudflare workers. See https://postit.monster for the soon to be completed website.

Server version: https://github.com/jschmidtnj/interviews/releases/tag/auth_server

| request             | description                                                  |
|---------------------|--------------------------------------------------------------|
| GET /               | index page, JSON message object                              |
| GET /hello          | hello world page, JSON message object                        |
| GET /auth/:username | register a new user with a given username. if one is already |
|                     | registered, throw an error. return plaintext public key      |
| GET /verify         | verify jwt. return plain text username                       |
| GET /README.md      | return this README file                                      |
| GET /stats          | return statistics on average time for encoding and decoding  |

## description

This project was written in rust. There are 2 versions, one that compiles to webassembly and is hosted in cloudflare workers, and a second that compiles to binary and runs locally (using actix web). They are functionally identical. They are in the `wasm` folder and `server` folders, respectively. The webassembly version requires a `wrangler.toml` file, and 2 secret variables - for jwt public and private keys. The `wrangler.toml` file can be created using the example in this directory. The keys can be generated by executing the script in the `keys/` folder. Below are helpful commands for the cloudflare wrangler cli:

```bash
wrangler build
wrangler dev
wrangler publish
```

I originally wrote this in go and thought it would be a piece of cake. It took around 3 hours to get it ~90% working. However, I really wanted it to work on cloudflare workers, and when including the dependency to sign jwt's, the bundle went above the 1kb (gzipped) limit. I added compile flags to remove debugging features, tried [tinygo](https://tinygo.org/), used webpack to reduce the javascript filesize, but it was still too large, and other workarounds I thought of had their own issues. I also attempted to download and install precompiled wasm in the serverless runtime, but due to some issues with v8 serialize it wouldn't work. In the end I decided to use rust.

I didn't use rust before other than in a few tutorials, so it was interesting learning it through this assignment. I can now say I am fairly comfortable with it, and it's pretty different than the c++ systems work I'm used to. I did run into many problems compiling for the wasm runtime. One that stood out is the wasm runtime doesn't have access to the  `std::time::Instant` library, which was being used to generate jwt's. Thankfully there is [this crate](https://crates.io/crates/instant), which uses javascript's `Date.now()` function as a polyfill. The main jwt library for rust, https://docs.rs/jsonwebtoken, unfortunately had too many incompatible dependencies, so I instead used a crate that is more compatible with a wasm runtime: https://crates.io/crates/jwt-simple. This crate did need modification, replacing instances of `std::time::Instant` with `instant::Instant`. See my fork here: https://github.com/jschmidtnj/rust-jwt-simple. There was also an issue compiling with `wrangler build` on arch linux, so I ended up using an ubuntu virtual machine for development.

I created the `server` version because the instructions said it should be able to run locally, and I assumed that to mean natively. It was pretty straight-forward to port the logic over and reuse files through simlinks. One issue I had was I needed to read from workers kv, but the rust api wrapper didn't have that method implemented. I ended up forking the repo (https://github.com/jschmidtnj/cloudflare-rs) and implementing the `Read` method. I have a feeling the reason it wasn't implemented is the return type is plain text, and not json, which is what the rest of the library is based around. I initially thought I would return plaintext from the `request` function, but after dealing with rust typing issues for a couple hours I decided to create a separate `request_text` function that returns a string. I'll clean it up and create a pull request sometime.

The most difficult part was getting everything working with wasm in the cloudflare workers runtime. I did all the extra credit, and am working on integrating with my web app. See the endpoints above.
